import asyncio
import random
import sqlite3
from datetime import datetime, timedelta

from aiogram import Bot, Dispatcher, types
from aiogram.filters import Command
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton

TOKEN = "8367668487:AAHbCN27Pq-84KGqXGevJ4B3yliEcP8IYbU"
ADMIN_CODE = "999rubs"
REF_BONUS = 10

bot = Bot(TOKEN)
dp = Dispatcher()

# ---------- –ë–ê–ó–ê ----------
conn = sqlite3.connect("game.db")
cursor = conn.cursor()

cursor.execute("""
CREATE TABLE IF NOT EXISTS users (
    user_id INTEGER PRIMARY KEY,
    coins INTEGER DEFAULT 0,
    last_roll TEXT,
    rolls_today INTEGER DEFAULT 0,
    luck_until TEXT,
    is_admin INTEGER DEFAULT 0,
    referrer INTEGER,
    skip_cd INTEGER DEFAULT 0,
    banned INTEGER DEFAULT 0,
    vip_until TEXT
)
""")
conn.commit()


# ---------- –£–¢–ò–õ–ò–¢–´ ----------
def get_user(uid):
    cursor.execute("SELECT * FROM users WHERE user_id=?", (uid,))
    u = cursor.fetchone()
    if not u:
        cursor.execute("INSERT INTO users (user_id) VALUES (?)", (uid,))
        conn.commit()
        return get_user(uid)
    return u


def has_luck(until):
    return until and datetime.fromisoformat(until) > datetime.now()


def is_vip(until):
    return until and datetime.fromisoformat(until) > datetime.now()


# ---------- –ö–ù–û–ü–ö–ò ----------
def main_kb(is_admin=False):
    kb = [
        [InlineKeyboardButton(text="üé≤ –ö—Ä—É—Ç–∏—Ç—å –∫—É–±–∏–∫", callback_data="roll")],
        [InlineKeyboardButton(text="üèÜ –¢–û–ü", callback_data="top")],
        [InlineKeyboardButton(text="üõí –ú–∞–≥–∞–∑–∏–Ω", callback_data="shop")],
        [InlineKeyboardButton(text="ü§ù –†–µ—Ñ–µ—Ä–∞–ª–∫–∞", callback_data="ref")]
    ]
    kb.append([
        InlineKeyboardButton(
            text="üëë –ê–¥–º–∏–Ω–∫–∞" if is_admin else "üîë –í–≤–µ—Å—Ç–∏ –∞–¥–º–∏–Ω-–∫–æ–¥",
            callback_data="admin_panel" if is_admin else "admin_code"
        )
    ])
    return InlineKeyboardMarkup(inline_keyboard=kb)


def admin_panel_kb():
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="üí∞ –í—ã–¥–∞—Ç—å –∫–æ–∏–Ω—ã", callback_data="admin_give")],
        [InlineKeyboardButton(text="üö´ –ó–∞–±–∞–Ω–∏—Ç—å", callback_data="admin_ban")],
        [InlineKeyboardButton(text="üîì –†–∞–∑–±–∞–Ω–∏—Ç—å", callback_data="admin_unban")],
        [InlineKeyboardButton(text="üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", callback_data="admin_stats")],
        [InlineKeyboardButton(text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="back")]
    ])


# ---------- START ----------
@dp.message(Command("start"))
async def start(msg: types.Message):
    args = msg.text.split()
    user = get_user(msg.from_user.id)

    # —Ä–µ—Ñ–µ—Ä–∞–ª
    if len(args) == 2:
        try:
            ref_id = int(args[1])
            if ref_id != msg.from_user.id and user[6] is None:
                cursor.execute(
                    "UPDATE users SET referrer=? WHERE user_id=?",
                    (ref_id, msg.from_user.id)
                )
                cursor.execute(
                    "UPDATE users SET coins = coins + ? WHERE user_id=?",
                    (REF_BONUS, ref_id)
                )
                conn.commit()
        except:
            pass

    await msg.answer(
        "üéÆ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –∏–≥—Ä—É —Å –∫—É–±–∏–∫–æ–º!",
        reply_markup=main_kb(user[5] == 1)
    )


# ---------- –†–ï–§–ï–†–ê–õ ----------
@dp.callback_query(lambda c: c.data == "ref")
async def ref(call: types.CallbackQuery):
    me = await bot.get_me()
    link = f"https://t.me/{me.username}?start={call.from_user.id}"
    await call.message.answer(
        f"ü§ù –¢–≤–æ—è —Å—Å—ã–ª–∫–∞:\n{link}\n\nüéÅ –ó–∞ –¥—Ä—É–≥–∞ +{REF_BONUS} –∫–æ–∏–Ω–æ–≤"
    )


# ---------- –ö–£–ë–ò–ö ----------
@dp.callback_query(lambda c: c.data == "roll")
async def roll(call: types.CallbackQuery):
    user = get_user(call.from_user.id)

    (
        uid, coins, last_roll, rolls_today, luck_until,
        is_admin, referrer, skip_cd, banned, vip_until
    ) = user

    if banned == 1:
        await call.answer("üö´ –¢—ã –∑–∞–±–∞–Ω–µ–Ω", show_alert=True)
        return

    now = datetime.now()
    vip = is_vip(vip_until)

    max_rolls = 20 if vip else 15
    cd_minutes = 5 if vip else 10

    if last_roll and datetime.fromisoformat(last_roll).date() != now.date():
        cursor.execute("UPDATE users SET rolls_today=0 WHERE user_id=?", (uid,))
        rolls_today = 0

    if rolls_today >= max_rolls:
        await call.answer("‚ùå –õ–∏–º–∏—Ç –±—Ä–æ—Å–∫–æ–≤", show_alert=True)
        return

    if last_roll and not skip_cd:
        next_time = datetime.fromisoformat(last_roll) + timedelta(minutes=cd_minutes)
        if now < next_time:
            await call.answer("‚è≥ –ü–æ–¥–æ–∂–¥–∏ –Ω–µ–º–Ω–æ–≥–æ", show_alert=True)
            return

    if vip:
        roll = random.choices([0,1,2,3,4,5,6],[5,5,5,5,25,25,30])[0]
    elif has_luck(luck_until):
        roll = random.choices([0,1,2,3,4,5,6],[10,10,10,10,20,20,20])[0]
    else:
        roll = random.randint(0, 6)

    reward = {4: 4, 5: 10, 6: 30}.get(roll, 0)
    coins += reward

    cursor.execute("""
    UPDATE users
    SET coins=?, last_roll=?, rolls_today=rolls_today+1, skip_cd=0
    WHERE user_id=?
    """, (coins, now.isoformat(), uid))
    conn.commit()

    await call.message.answer(
        f"üé≤ –í—ã–ø–∞–ª–æ: {roll}\nüí∞ –ù–∞–≥—Ä–∞–¥–∞: {reward}\nüíé –ë–∞–ª–∞–Ω—Å: {coins}"
    )


# ---------- –¢–û–ü ----------
@dp.callback_query(lambda c: c.data == "top")
async def top(call: types.CallbackQuery):
    cursor.execute("SELECT user_id, coins FROM users ORDER BY coins DESC LIMIT 10")
    text = "üèÜ –¢–û–ü-10:\n\n"
    for i, (uid, coins) in enumerate(cursor.fetchall(), 1):
        text += f"{i}. {uid} ‚Äî üí∞ {coins}\n"
    await call.message.answer(text)


# ---------- –ú–ê–ì–ê–ó–ò–ù ----------
@dp.callback_query(lambda c: c.data == "shop")
async def shop(call: types.CallbackQuery):
    kb = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="üçÄ –£–¥–∞—á–∞ +20% (20)", callback_data="buy_luck")],
        [InlineKeyboardButton(text="‚è± –°–±—Ä–æ—Å –ö–î (15)", callback_data="buy_cd")],
        [InlineKeyboardButton(text="üíé VIP 24—á (50)", callback_data="buy_vip")],
        [InlineKeyboardButton(text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="back")]
    ])
    await call.message.answer("üõí –ú–∞–≥–∞–∑–∏–Ω:", reply_markup=kb)


@dp.callback_query(lambda c: c.data == "buy_luck")
async def buy_luck(call: types.CallbackQuery):
    uid, coins, *_ = get_user(call.from_user.id)
    if coins < 20:
        await call.answer("‚ùå –ú–∞–ª–æ –∫–æ–∏–Ω–æ–≤", show_alert=True)
        return
    until = datetime.now() + timedelta(hours=1)
    cursor.execute("UPDATE users SET coins=coins-20, luck_until=? WHERE user_id=?", (until.isoformat(), uid))
    conn.commit()
    await call.message.answer("üçÄ –£–¥–∞—á–∞ –∞–∫—Ç–∏–≤–Ω–∞!")


@dp.callback_query(lambda c: c.data == "buy_cd")
async def buy_cd(call: types.CallbackQuery):
    uid, coins, *_ = get_user(call.from_user.id)
    if coins < 15:
        await call.answer("‚ùå –ú–∞–ª–æ –∫–æ–∏–Ω–æ–≤", show_alert=True)
        return
    cursor.execute("UPDATE users SET coins=coins-15, skip_cd=1 WHERE user_id=?", (uid,))
    conn.commit()
    await call.message.answer("‚è± –ö–î —Å–±—Ä–æ—à–µ–Ω!")


@dp.callback_query(lambda c: c.data == "buy_vip")
async def buy_vip(call: types.CallbackQuery):
    uid, coins, *_ = get_user(call.from_user.id)
    if coins < 50:
        await call.answer("‚ùå –ú–∞–ª–æ –∫–æ–∏–Ω–æ–≤", show_alert=True)
        return
    until = datetime.now() + timedelta(hours=24)
    cursor.execute("UPDATE users SET coins=coins-50, vip_until=? WHERE user_id=?", (until.isoformat(), uid))
    conn.commit()
    await call.message.answer("üíé VIP –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!")


# ---------- –ê–î–ú–ò–ù ----------
@dp.callback_query(lambda c: c.data == "admin_code")
async def admin_code(call: types.CallbackQuery):
    kb = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="üîê –í–≤–µ—Å—Ç–∏ –∫–æ–¥ 999rubs", callback_data="admin_confirm")],
        [InlineKeyboardButton(text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="back")]
    ])
    await call.message.answer("üîë –í–≤–æ–¥ –∞–¥–º–∏–Ω-–∫–æ–¥–∞:", reply_markup=kb)


@dp.callback_query(lambda c: c.data == "admin_confirm")
async def admin_confirm(call: types.CallbackQuery):
    cursor.execute("UPDATE users SET is_admin=1 WHERE user_id=?", (call.from_user.id,))
    conn.commit()
    await call.message.answer("üëë –¢—ã –∞–¥–º–∏–Ω!", reply_markup=admin_panel_kb())


@dp.callback_query(lambda c: c.data == "admin_panel")
async def admin_panel(call: types.CallbackQuery):
    await call.message.answer("üëë –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å:", reply_markup=admin_panel_kb())


@dp.callback_query(lambda c: c.data == "admin_stats")
async def admin_stats(call: types.CallbackQuery):
    cursor.execute("SELECT COUNT(*) FROM users")
    users = cursor.fetchone()[0]
    cursor.execute("SELECT COUNT(*) FROM users WHERE banned=1")
    banned = cursor.fetchone()[0]
    await call.message.answer(f"üìä –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {users}\nüö´ –ó–∞–±–∞–Ω–µ–Ω–æ: {banned}")


@dp.callback_query(lambda c: c.data == "back")
async def back(call: types.CallbackQuery):
    user = get_user(call.from_user.id)
    await call.message.answer("üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", reply_markup=main_kb(user[5] == 1))


# ---------- –ó–ê–ü–£–°–ö ----------
async def main():
    await dp.start_polling(bot)

if __name__ == "__main__":
    asyncio.run(main())
